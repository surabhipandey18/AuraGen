{% extends "base.html" %}

{% block title %}Your Calm Space - SoulBloom{% endblock %}

{% block content %}
<p style="text-align:center; font-family:'Bree Serif', serif; margin: 10px auto; max-width:600px; color:#021D4F;">This is your personal space to relax, recharge, and feel at peace.</p>
<main style="padding:1rem; max-width:900px; margin:auto;">
    <div class="card">
        <h2>Music & Podcasts</h2>
        <p>Search by item or select mood.</p>
        <!-- Search input -->
        <input type="text" id="spotifyQuery" placeholder="Search for songs or podcasts...">

        <!-- Type select -->
        <select id="spotifyType">
            <option value="track">Songs </option>
            <option value="show">Podcasts </option>
        </select>

        <!-- Mood select -->
        <select id="spotifyMood">
            <option value="">-- Select Mood --</option>
            <option value="happy">ðŸ˜Š Happy</option>
            <option value="sad">ðŸ˜” Sad</option>
            <option value="relaxed">ðŸ˜Œ Relaxed</option>
            <option value="energetic">âš¡ Energetic</option>
        </select>

        <!-- Search button -->
        <button class="btn" onclick="searchSpotify()"><img src="{{ url_for('static', filename='images/search.png') }}">Search</button>
    </div>

    <div id="spotifyResults"></div>
</main>
<script>
function searchSpotify() {
    const query = document.getElementById("spotifyQuery").value.trim();
    const type = document.getElementById("spotifyType").value;
    const mood = document.getElementById("spotifyMood").value;

    if (!query && !mood) {
        alert("Please enter a search term or select a mood!");
        return;
    }

    let finalQuery = query;
    if (mood) finalQuery += " " + mood;  // Add mood to query

    fetch(`/api/spotify/search?q=${encodeURIComponent(finalQuery)}&type=${type}`)
    .then(r => r.json())
    .then(data => {
        const results = document.getElementById("spotifyResults");
        results.innerHTML = "";

        if (type === "track" && data.tracks?.items?.length > 0) {
            data.tracks.items.forEach(tr => {
                const div = document.createElement("div");
                div.className = "entry";
                const spotifyLink = tr.external_urls?.spotify || "#";
                div.innerHTML = `
                    <img src="${tr.album.images[0]?.url || ''}"><br>
                    <strong>${tr.name}</strong><br>
                    <em>${tr.artists.map(a=>a.name).join(", ")}</em><br>
                    <a class="btn" href="${spotifyLink}" target="_blank">Open in Spotify</a><br>
                    ${tr.preview_url ? `<audio controls src="${tr.preview_url}"></audio>` : "<em>No preview available</em>"}
                `;
                results.appendChild(div);
            });
        }

        if (type === "show" && data.shows?.items?.length > 0) {
            data.shows.items.forEach(show => {
                const div = document.createElement("div");
                div.className = "entry";
                const spotifyLink = show.external_urls?.spotify || "#";
                div.innerHTML = `
                    <img src="${show.images[0]?.url || ''}"><br>
                    <strong>${show.name}</strong><br>
                    <em>${show.publisher}</em><br>
                    <a href="${spotifyLink}" target="_blank">Listen on Spotify</a>
                `;
                results.appendChild(div);
            });
        }

        if ((type === "track" && !data.tracks?.items?.length) ||
            (type === "show" && !data.shows?.items?.length)) {
            results.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>No results found ðŸ˜”</p>";
        }
    })
    .catch(err => {
        console.error("Spotify error:", err);
        document.getElementById("spotifyResults").innerHTML = "<p style='grid-column:1/-1; text-align:center; color:red;'>Error fetching results.</p>";
    });
}
</script>

{% endblock %}
