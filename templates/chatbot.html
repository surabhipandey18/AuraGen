{% extends "base.html" %}

{% block title %}Chatbot - SoulBloom{% endblock %}

{% block content %}
<main>
  <p style="text-align:center; font-family:'Bree Serif', serif; margin: 10px auto; max-width:600px; color:#021D4F;">Sometimes, you just need someone to listen. Our AI-powered chatbot is here 24/7 to support you whenever you feel low, stressed, or just want to share your thoughts.</p>
  <div class="chat-container">
    <h1>ðŸŒ¸ SoulBloom Chatbot</h1>
    <div id="chat-box" class="chat-box"></div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="Type your message..." />
      <button class="btn" onclick="sendMessage()"><img src="{{ url_for('static', filename='images/send.png') }}">Send</button>
    </div>
  </div>

  <script>
    function getTime() {
      const now = new Date();
      return now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const message = input.value.trim();
      if (!message) return;

      const chatBox = document.getElementById("chat-box");

      // User message
      const userDiv = document.createElement("div");
      userDiv.className = "user";
      userDiv.innerHTML = `<span class="msg-text">You: ${message}</span> <span class="time">${getTime()}</span>`;
      chatBox.appendChild(userDiv);
      input.value = "";
      chatBox.scrollTop = chatBox.scrollHeight;

      // Bot typing indicator
      const typingDiv = document.createElement("div");
      typingDiv.className = "bot typing";
      typingDiv.innerHTML = `<span></span><span></span><span></span>`;
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        let response = await fetch("/api/chat", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ message })
        });
        let data = await response.json();

        // Remove typing
        typingDiv.remove();

        // Bot reply
        const botDiv = document.createElement("div");
        botDiv.className = "bot";
        botDiv.innerHTML = `<span class="msg-text">Bot: ${data.reply}</span> <span class="time">${getTime()}</span>`;
        chatBox.appendChild(botDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (err) {
        typingDiv.remove();
        const errorDiv = document.createElement("div");
        errorDiv.className = "bot";
        errorDiv.innerHTML = `<span class="msg-text">Bot: Error connecting to server.</span> <span class="time">${getTime()}</span>`;
        chatBox.appendChild(errorDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        console.error(err);
      }
    }
  </script>
</main>

{% endblock %}
